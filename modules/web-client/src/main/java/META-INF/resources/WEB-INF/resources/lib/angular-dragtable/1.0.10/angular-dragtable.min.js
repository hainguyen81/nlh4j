angular.module("Dragtable",[]).directive("dragMe",[function(){return{link:function(e,t,n){t.attr("draggable",!0),n.handle&&t.find(n.handle)?t.find(n.handle).attr("style","cursor:move;"):t.attr("style","cursor:move;");var i,r,a=n.limit||50,o=0,l=!1,d=!1,s=!1,f='<div class="ghost" style="position: fixed;">{ghostHtml}</div>',h='<div class="{elemClass}" style="height: {height}px; width: {width}px;">{text}</div>';$(document).on("dragover",function(e){i=e.originalEvent.clientX,r=e.originalEvent.clientY});var u=function(e,t){for(var n in t)e=e.replace(new RegExp("{"+n+"}","g"),t[n]);return e},g=function(e){o=e.originalEvent.clientX-t.offset().left},c=function(e){s&&s.remove(),g(e),m(v())},v=function(){var e="",n=t.index()+1,i=t.closest("table").find("tr td:nth-child("+n+"):visible");i.addClass("ghost__data");var r=i.length;r>a&&(r=a);for(var o=0;o<r;o++){var l=$(i[o]);e+=u(h,{elemClass:"ghost__td",height:l.outerHeight(),width:l.outerWidth(),text:l.html()})}return e},m=function(e){t.closest("table").before(u(f,{ghostHtml:e})),s=$(".ghost");var n=t.offset();s.css("top",n.top-$(window).scrollTop()+t.outerHeight()),s.css("left",n.left)},p=function(){angular.element(".ghost__placeholder").removeClass("ghost__placeholder").removeAttr("width"),angular.element(".ghost__data").removeClass("ghost__data")};t.bind("mousedown",function(e){d=e.target}),t.bind("dragstart",function(e){return"undefined"!=typeof e.originalEvent.dataTransfer&&"undefined"!=typeof e.originalEvent.dataTransfer.mozSourceNode&&e.originalEvent.dataTransfer.setData("application/node type",this),!(n.handle&&!$(d).hasClass(n.handle)&&!$(d).closest(n.handle).length)&&(p(),t.addClass("ghost__placeholder").attr("width",t.outerWidth()),void c(e))}),t.bind("drag",function(e){clearTimeout(l),l=setTimeout(function(){s&&s.css("left",i-o)},5)}),t.bind("dragend",function(e){s&&s.remove(),p(),d=!1})}}}]).directive("dropMe",[function(){return{link:function(e,t,n){var i=!1,r=!1,a=!1,o=function(e,n){if(e===r&&n===r)return!1;var i=angular.element(".ghost__placeholder").last(),o=angular.element("tbody td:nth-child("+n+")"),l=angular.element(".ghost__data"),d=o.length;if("right"===e){t.after(i);for(var s=0;s<d&&"undefined"!=typeof l[s];s++)$(o[s]).after(l[s])}else if("left"===e){t.before(i);for(var f=0;f<d&&"undefined"!=typeof l[f];f++)$(o[f]).before(l[f])}r=e,a=n};t.bind("dragover",function(e){e.preventDefault(),clearTimeout(i),i=setTimeout(function(){var n=e.originalEvent.x>t.offset().left+t.width()/2?"right":"left";o(n,t.index()+1)},50)}),t.bind("drop",function(e){var n=e.originalEvent.x>t.offset().left+t.width()/2?"right":"left";o(n,t.index()+1,!0)})}}}]);