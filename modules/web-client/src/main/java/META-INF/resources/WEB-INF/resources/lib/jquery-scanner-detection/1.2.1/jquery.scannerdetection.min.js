(function($){$.fn.scannerDetection=function(options){if(typeof options==="string"){this.each(function(){this.scannerDetectionTest(options)});return this}
if(options===!1){this.each(function(){this.scannerDetectionOff()});return this}
var defaults={onComplete:!1,onError:!1,onReceive:!1,onKeyDetect:!1,timeBeforeScanTest:100,avgTimeByChar:30,minLength:6,endChar:[9,13],startChar:[],ignoreIfFocusOn:!1,scanButtonKeyCode:!1,scanButtonLongPressThreshold:3,onScanButtonLongPressed:!1,stopPropagation:!1,preventDefault:!1};if(typeof options==="function"){options={onComplete:options}}
if(typeof options!=="object"){options=$.extend({},defaults)}else{options=$.extend({},defaults,options)}
this.each(function(){var self=this,$self=$(self),firstCharTime=0,lastCharTime=0,stringWriting='',callIsScanner=!1,testTimer=!1,scanButtonCounter=0;var initScannerDetection=function(){firstCharTime=0;stringWriting='';scanButtonCounter=0};self.scannerDetectionOff=function(){$self.unbind('keydown.scannerDetection');$self.unbind('keypress.scannerDetection')}
self.isFocusOnIgnoredElement=function(){if(!options.ignoreIfFocusOn)return!1;if(typeof options.ignoreIfFocusOn==='string')return $(':focus').is(options.ignoreIfFocusOn);if(typeof options.ignoreIfFocusOn==='object'&&options.ignoreIfFocusOn.length){var focused=$(':focus');for(var i=0;i<options.ignoreIfFocusOn.length;i++){if(focused.is(options.ignoreIfFocusOn[i])){return!0}}}
return!1}
self.scannerDetectionTest=function(s){if(s){firstCharTime=lastCharTime=0;stringWriting=s}
if(!scanButtonCounter){scanButtonCounter=1}
if(stringWriting.length>=options.minLength&&lastCharTime-firstCharTime<stringWriting.length*options.avgTimeByChar){if(options.onScanButtonLongPressed&&scanButtonCounter>options.scanButtonLongPressThreshold)options.onScanButtonLongPressed.call(self,stringWriting,scanButtonCounter);else if(options.onComplete)options.onComplete.call(self,stringWriting,scanButtonCounter);$self.trigger('scannerDetectionComplete',{string:stringWriting});initScannerDetection();return!0}else{if(options.onError)options.onError.call(self,stringWriting);$self.trigger('scannerDetectionError',{string:stringWriting});initScannerDetection();return!1}}
$self.data('scannerDetection',{options:options}).unbind('.scannerDetection').bind('keydown.scannerDetection',function(e){if(options.scanButtonKeyCode!==!1&&e.which==options.scanButtonKeyCode){scanButtonCounter++;e.preventDefault();e.stopImmediatePropagation()}
else if((firstCharTime&&options.endChar.indexOf(e.which)!==-1)||(!firstCharTime&&options.startChar.indexOf(e.which)!==-1)){var e2=jQuery.Event('keypress',e);e2.type='keypress.scannerDetection';$self.triggerHandler(e2);e.preventDefault();e.stopImmediatePropagation()}
if(options.onKeyDetect)options.onKeyDetect.call(self,e);$self.trigger('scannerDetectionKeyDetect',{evt:e})}).bind('keypress.scannerDetection',function(e){if(this.isFocusOnIgnoredElement())return;if(options.stopPropagation)e.stopImmediatePropagation();if(options.preventDefault)e.preventDefault();if(firstCharTime&&options.endChar.indexOf(e.which)!==-1){e.preventDefault();e.stopImmediatePropagation();callIsScanner=!0}else if(!firstCharTime&&options.startChar.indexOf(e.which)!==-1){e.preventDefault();e.stopImmediatePropagation();callIsScanner=!1}else{if(typeof(e.which)!='undefined'){stringWriting+=String.fromCharCode(e.which)}
callIsScanner=!1}
if(!firstCharTime){firstCharTime=Date.now()}
lastCharTime=Date.now();if(testTimer)clearTimeout(testTimer);if(callIsScanner){self.scannerDetectionTest();testTimer=!1}else{testTimer=setTimeout(self.scannerDetectionTest,options.timeBeforeScanTest)}
if(options.onReceive)options.onReceive.call(self,e);$self.trigger('scannerDetectionReceive',{evt:e})})});return this}})(jQuery)